name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================================================
  # Build and Test Share Project
  # ============================================================================
  build-share:
    name: Build Share (DTOs & Enums)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Sync package-lock and install dependencies
        working-directory: Ark.Alliance.TrendsCalculator.Share
        run: npm install
      
      - name: Build Share project
        working-directory: Ark.Alliance.TrendsCalculator.Share
        run: npm run build
      
      - name: Upload Share build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: share-build-${{ matrix.node-version }}
          path: Ark.Alliance.TrendsCalculator.Share/dist/
          retention-days: 7


  # ============================================================================
  # Build and Test Backend
  # ============================================================================
  build-backend:
    name: Build Backend (API + WebSocket)
    runs-on: ubuntu-latest
    needs: build-share
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Download Share artifacts
        uses: actions/download-artifact@v4
        with:
          name: share-build-${{ matrix.node-version }}
          path: Ark.Alliance.TrendsCalculator.Share/dist/
      
      - name: Install dependencies
        working-directory: Ark.Alliance.TrendsCalculator.Backend
        run: npm install --ignore-scripts || npm install --legacy-peer-deps --ignore-scripts
        continue-on-error: true
      
      - name: Install dependencies (fallback)
        if: failure()
        working-directory: Ark.Alliance.TrendsCalculator.Backend
        run: npm install --legacy-peer-deps
      
      - name: Lint backend code
        working-directory: Ark.Alliance.TrendsCalculator.Backend
        run: npm run lint --if-present || echo "No lint script found"
      
      - name: Build backend project
        working-directory: Ark.Alliance.TrendsCalculator.Backend
        run: npm run build
      
      - name: Upload backend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build-${{ matrix.node-version }}
          path: Ark.Alliance.TrendsCalculator.Backend/dist/
          retention-days: 7

  # ============================================================================
  # Build and Test Frontend
  # ============================================================================
  build-frontend:
    name: Build Frontend (React + Vite)
    runs-on: ubuntu-latest
    needs: build-share
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Download Share artifacts
        uses: actions/download-artifact@v4
        with:
          name: share-build-${{ matrix.node-version }}
          path: Ark.Alliance.TrendsCalculator.Share/dist/
      
      - name: Install dependencies
        working-directory: Ark.Alliance.TrendsCalculator.Ui
        run: npm install
      
      - name: Lint frontend code
        working-directory: Ark.Alliance.TrendsCalculator.Ui
        run: npm run lint --if-present || echo "No lint script found"
      
      - name: Build frontend project
        working-directory: Ark.Alliance.TrendsCalculator.Ui
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ matrix.node-version }}
          path: Ark.Alliance.TrendsCalculator.Ui/dist/
          retention-days: 7

  # ============================================================================
  # Run Tests (if test project exists)
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [build-share, build-backend, build-frontend]
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Check if tests exist
        id: check-tests
        run: |
          if [ -f "Ark.Alliance.TrendsCalculator.Tests/package.json" ]; then
            echo "tests_exist=true" >> $GITHUB_OUTPUT
          else
            echo "tests_exist=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Install test dependencies
        if: steps.check-tests.outputs.tests_exist == 'true'
        working-directory: Ark.Alliance.TrendsCalculator.Tests
        run: npm install
      
      - name: Run tests
        if: steps.check-tests.outputs.tests_exist == 'true'
        working-directory: Ark.Alliance.TrendsCalculator.Tests
        run: npm test
        env:
          CI: true

  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Check TypeScript files
        run: |
          echo "Checking TypeScript configuration..."
          find . -name "tsconfig.json" -type f | head -n 5
      
      - name: Check for secrets
        run: |
          echo "Scanning for potential secrets..."
          ! grep -r "api_key\|api_secret\|password\|token" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=dist . || echo "Warning: Found potential secrets in code"

  # ============================================================================
  # Deployment (Production only)
  # ============================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build-20.x
          path: backend-dist
      
      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-20.x
          path: frontend-dist
      
      - name: Deploy placeholder
        run: |
          echo "Deployment step - configure with your deployment strategy"
          echo "Backend artifacts: backend-dist/"
          echo "Frontend artifacts: frontend-dist/"
          # Add your deployment commands here
          # Example: scp, rsync, Docker, Kubernetes, etc.
