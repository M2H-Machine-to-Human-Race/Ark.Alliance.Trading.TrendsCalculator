name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================================================
  # Build and Test Share Project
  # ============================================================================
  build-share:
    name: Build Share (DTOs & Enums)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Install Share dependencies
        working-directory: Ark.Alliance.TrendsCalculator.Share
        run: npm install
      
      - name: Build Share project
        working-directory: Ark.Alliance.TrendsCalculator.Share
        run: npm run build
      
      - name: Upload Share build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: share-build-${{ matrix.node-version }}
          path: |
            Ark.Alliance.TrendsCalculator.Share/dist/
            Ark.Alliance.TrendsCalculator.Share/node_modules/
            Ark.Alliance.TrendsCalculator.Share/package.json
          retention-days: 7

  # ============================================================================
  # Build and Test Frontend
  # ============================================================================
  build-frontend:
    name: Build Frontend (React + Vite)
    runs-on: ubuntu-latest
    needs: build-share
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Download Share artifacts
        uses: actions/download-artifact@v4
        with:
          name: share-build-${{ matrix.node-version }}
          path: Ark.Alliance.TrendsCalculator.Share/
      
      - name: Install Frontend dependencies
        working-directory: Ark.Alliance.TrendsCalculator.Ui
        run: npm install
      
      - name: Lint frontend code
        working-directory: Ark.Alliance.TrendsCalculator.Ui
        run: npm run lint --if-present || echo "Lint completed with warnings"
        continue-on-error: true
      
      - name: Build frontend project
        working-directory: Ark.Alliance.TrendsCalculator.Ui
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ matrix.node-version }}
          path: Ark.Alliance.TrendsCalculator.Ui/dist/
          retention-days: 7

  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Check TypeScript files exist
        run: |
          echo "Checking TypeScript configuration..."
          find . -name "tsconfig.json" -type f | head -n 5
      
      - name: Check for potential secrets
        run: |
          echo "Scanning for potential secrets..."
          ! grep -rE "(api_key|api_secret|password|token)\s*[:=]" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=dist . || echo "Warning: Review flagged items for false positives"
        continue-on-error: true

  # ============================================================================
  # Summary Job (replaces Backend build for now)
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-share, build-frontend, code-quality]
    if: always()
    
    steps:
      - name: Check build results
        run: |
          echo "=== CI/CD Pipeline Summary ==="
          echo ""
          echo "Share Build: ${{ needs.build-share.result }}"
          echo "Frontend Build: ${{ needs.build-frontend.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo ""
          echo "Note: Backend build is skipped in CI because it requires"
          echo "the ark-alliance-trading-providers-lib which is a local dependency."
          echo "Backend should be tested locally before pushing."
          echo ""
          if [ "${{ needs.build-share.result }}" == "failure" ] || [ "${{ needs.build-frontend.result }}" == "failure" ]; then
            echo "❌ CI Failed - Please check the logs above"
            exit 1
          else
            echo "✅ CI Passed"
          fi
